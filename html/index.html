<%include header.html%>
<style>
  .btn-font { font-size: 14px; }
  .hide {visibility: hidden;}
</style>
      <!-- Navbar -->
      <nav class="navbar navbar-expand-lg navbar-absolute fixed-top navbar-transparent">
        <div class="container-fluid">
          <div class="navbar-wrapper">
            <div class="navbar-toggle">
              <button type="button" class="navbar-toggler">
                <span class="navbar-toggler-bar bar1"></span>
                <span class="navbar-toggler-bar bar2"></span>
                <span class="navbar-toggler-bar bar3"></span>
              </button>
            </div>
            <a class="navbar-brand" href="#">Run Command Interface</a>
          </div>
          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation" aria-controls="navigation-index" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
            <span class="navbar-toggler-bar navbar-kebab"></span>
          </button>
        </div>
      </nav>
      <!-- End Navbar -->


  <div class="content">
    <input type="hidden" id="foldername" value="" />
    <div class="row">
      <div class="col-lg-12">
        <div id="lastrunat" class="stats pull-right"></div>
      </div>
      <div class="col-lg-6" style="background-color: #0a8717">
        <div class="typo-line">
          <div id="upload-progress" class="progress-container progress-success hide">
            <span class="progress-badge">Success</span>
            <div class="progress">
              <div class="progress-bar progress-bar-success" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
              </div>
            </div>
          </div>
          <div id="">
            <span id="dZUpload" class="btn btn-info btn-font">Browse or click here </span>
          </div>
          
          <table id="upload" class="table table-striped table-bordered"
           style="width:100%;"></table>
        </div>
      </div>

      <div class="col-lg-6" style="background-color: #ef8157">
        <div class="typo-line">
          <div id="report-progress" class="progress-container progress-success hide">
            <span class="progress-badge">Success</span>
            <div class="progress">
              <div class="progress-bar progress-bar-success" role="progressbar" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
              </div>
            </div>
          </div>
          <div id="">
            <button id="command" class="btn btn-info btn-font">Apply algorithm</button>
          </div>
        <table id="report" class="table table-striped table-bordered" style="width:100%"></table>

        </div>
      </div>

     <!--  <div class="card-footer ">
        <hr>  
        
      </div> -->
        
    </div>
  </div> <!-- end content -->
</div>
</div>
<%include footer.html%>

<script type="text/javascript">
  $(document).ready(function(){
    Dropzone.autoDiscover = false;
    var myDropzone = new Dropzone("#dZUpload",
      { 
        url: "/upload-files",
        uploadMultiple: true,  //upload multiple files
        maxFilesize: 50000,  //1 mb is here the max file upload size constraint
        acceptedFiles: ".jpeg,.pdf, .zip",
        paramName: function(n) { return 'source_file[]';},
        parallelUploads: 500,
      }
    );
    myDropzone.on("addedfile", function(file) {
      file.previewElement.innerHTML = "";
      $('#upload-progress').removeClass('hide'); 
      $('#upload-progress .progress-badge').html('File upload in progress.');
      $('#upload-progress .progress-bar').width('0%');
    });
    myDropzone.on("totaluploadprogress", function (progress) {
      // file.previewElement.innerHTML = "";
      $("#upload-progress .progress-bar").width(progress + '%');
      $("#upload-progress .progress-badge").text('File upload in progress. Percentage progress  '+progress + '%');
    });
    myDropzone.on("success", function(file, response) {
      $('#foldername').val(response.nameFolder);
      file.previewElement.innerHTML = "";
      $('.progress-container .progress-badge').html('File upload complete.');
      $('.progress-container .progress-bar').width('100%');
      showTableUpload(myDropzone.files);
      fetchReports();
      setTimeout(function(){ 
        $('.progress-container').addClass('hide');
        myDropzone.removeAllFiles();
      }, 5000);      
    });

    function showTableUpload(files){
      var varhtml = '';
      varhtml += '<thead><tr><th>Index</th><th>Name</th><th>Size</th></tr></thead>';
      varhtml += '<tbody>';
        var rowhtml = files.forEach(function(item, index) {
          index
          varhtml += '<tr>';
            varhtml += '<td>'+ (index+1) +'</td>';
            varhtml += '<td>'+item.name+'</td>';
            varhtml += '<td>'+ Math.round((item.size/ 1000),2)+' kb</td>';
        varhtml += '</tr>';
        });
     varhtml += '</tbody>';
     $('#upload').html(varhtml);

     //  $('#example').DataTable({
     //  "iDisplayLength": 5,
     //  "bLengthChange" : false, //thought this line could hide the LengthMenu
     //  "bInfo":false,
     //  "searching": false,
     // });
    }

  function fetchReports(){
    var id = $('#foldername').val();
    $.ajax({
        type: "GET",
        url: '/fetch-report/'+id,
        success: function(data, status){
            if(data.status == true){
              showTableReport(data.arrList,id);
            }else{
              $('#lastrunat').html('<i class="nc-icon nc-time"></i> Last run successfuly at '+ getTime() );
            }
        },
        dataType: "json",
        crossDomain:true
      });
  }

    function showTableReport(files, id){
      var varhtml = '';
      varhtml += '<thead><tr><th>Index</th><th>Name</th><th>Size</th></tr></thead>';
      varhtml += '<tbody>';
        var rowhtml = files.forEach(function(item, index) {
          index
          varhtml += '<tr>';
            varhtml += '<td>'+ (index+1) +'</td>';
            varhtml += '<td><a target="_blank" href="read-report/'+id+'/'+item+'" >'+item+'</a></td>';
            varhtml += '<td></td>';
        varhtml += '</tr>';
        });
     varhtml += '</tbody>';
     $('#report').html(varhtml);

     //  $('#example').DataTable({
     //  "iDisplayLength": 5,
     //  "bLengthChange" : false, //thought this line could hide the LengthMenu
     //  "bInfo":false,
     //  "searching": false,
     // });
    }


    $('#lastrunat').html('Browse file and process it.' );
    function getTime(){
      const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
      var today = new Date();
      var date = today.getDate()+' '+(monthNames[today.getMonth()])+', '+today.getFullYear();
      var time = today.toLocaleString('en-US', { hour: 'numeric', minute: 'numeric', second: 'numeric', hour12: true });
      var dateTime = date+' '+time;
      return dateTime;
    }
    $('#command').click(function(){
      var foldername = $('#foldername').val();
      $.ajax({
        type: "POST",
        url: '/run',
        data: {'foldername': foldername},
        success: function(data, status){
            if(data.status == true){
              $('#response').html(data.msg);
              $('#lastrunat').html('<i class="nc-icon nc-time"></i> Last run successfuly at '+ getTime() );
            }else{
              $('#response').html(data.err);
              $('#lastrunat').html('<i class="nc-icon nc-time"></i> Last run successfuly at '+ getTime() );
            }
        },
        dataType: "json",
        crossDomain:true
      });
    });

  function randomString(length ) {
    var chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'
    var result = '';
    for (var i = length; i > 0; --i) result += chars[Math.floor(Math.random() * chars.length)];
    return result;
  }
})
</script>